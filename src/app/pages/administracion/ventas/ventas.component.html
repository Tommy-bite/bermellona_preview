<div class="container my-5">
  <div class="row justify-content-between align-items-center my-5">
    <!-- Buscador -->
    <div class="col-md-6 d-flex align-items-center">
      <div class="input-group" style="width: 50%">
        <span class="input-group-text bg-success text-white">
          <i class="bi bi-search"></i>
        </span>
        <input type="search" class="form-control" placeholder="Buscar Venta"  (keyup)="applyFilter($event)" />
      </div>
    </div>
  </div>

  <div class="table-responsive">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
      <ng-container matColumnDef="codigo">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Codigo
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.codigo }}
        </td>
      </ng-container>

      <ng-container matColumnDef="fecha">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Fecha
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.fecha | date : "dd/MM/yyyy" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="rut_cliente">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Rut
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.rut_cliente }}
        </td>
      </ng-container>

      <ng-container matColumnDef="nombre_cliente">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Nombre
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.nombre_cliente }}
        </td>
      </ng-container>

      <ng-container matColumnDef="apellido_cliente">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Apellido
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.apellido_cliente }}
        </td>
      </ng-container>

      <ng-container matColumnDef="email_cliente">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Email
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.email_cliente }}
        </td>
      </ng-container>

      <ng-container matColumnDef="opcion_entrega">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Opcion Entrega
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.opcion_entrega }}
        </td>
      </ng-container>

      <ng-container matColumnDef="region">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Region
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.region }}
        </td>
      </ng-container>

      <ng-container matColumnDef="comuna">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Comuna
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.comuna }}
        </td>
      </ng-container>

      <ng-container matColumnDef="calle">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Calle
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.calle }}
        </td>
      </ng-container>

      <ng-container matColumnDef="celular">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Celular
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.celular }}
        </td>
      </ng-container>
      <ng-container matColumnDef="valor_total">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Total pagado
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.valor_total | monedaChilena }}
        </td>
      </ng-container>
      <ng-container matColumnDef="metodo_pago">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Metodo de pago
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.metodo_pago }}
        </td>
      </ng-container>
      <ng-container matColumnDef="productos">
        <th mat-header-cell *matHeaderCellDef class="bg-dark text-white fw-bold">
          Productos
        </th>
        <td mat-cell *matCellDef="let element">
          <button
            class="btn btn-info mx-2"
            title="Ver Productos"
            (click)="abrirModalProductos(element)"
          >
            <i class="bi bi-eye-fill"></i>
          </button>
        </td>
      </ng-container>
      <ng-container matColumnDef="estado">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Estado
        </th>
        <td mat-cell *matCellDef="let element">
          {{ element.estado }}
        </td>
      </ng-container>

      <ng-container matColumnDef="acciones">
        <th
          mat-header-cell
          *matHeaderCellDef
          class="bg-dark text-white fw-bold"
        >
          Acciones
        </th>
        <td mat-cell *matCellDef="let element">
          <button
            class="btn btn-warning mx-2"
            title="Cambiar estado"
            (click)="abrirModal(element)"
          >
            <i class="bi bi-pen-fill"></i>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>

  <mat-paginator
    [pageSizeOptions]="[5, 10, 25, 100]"
    aria-label="Select page of users"
  ></mat-paginator>
</div>

<!-- Modal Bootstrap -->
<!-- Modal Bootstrap -->
<div
  class="modal fade"
  id="estadoModal"
  tabindex="-1"
  aria-labelledby="estadoModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="estadoModalLabel">Actualizar Estado de la Compra</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Código de Venta:</strong> {{ ventaSeleccionada?.codigo }}</p>
        <div class="form-group">
          <label for="nuevoEstado">Selecciona el nuevo estado</label>
          <select
            class="form-select"
            [(ngModel)]="nuevoEstado"
            id="nuevoEstado"
            (change)="onEstadoChange()"
          >
            <option *ngFor="let estado of estados" [value]="estado">{{ estado }}</option>
          </select>
        </div>

        <!-- Campos adicionales si se selecciona "En despacho" -->
        <div *ngIf="nuevoEstado === 'En despacho'" class="mt-3">
          <div class="form-group">
            <label for="numeroEnvio">Número de Envío</label>
            <input
              type="text"
              class="form-control"
              id="numeroEnvio"
              [(ngModel)]="numeroEnvio"
              placeholder="Escribe el número de envío"
            />
          </div>
          <div class="form-group mt-2">
            <label for="despachador">Despachador</label>
            <input
              type="text"
              class="form-control"
              id="despachador"
              [(ngModel)]="despachador"
              placeholder="Escribe el nombre del despachador"
            />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="actualizarEstado()"
        >
          Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Productos -->
<div
  class="modal fade"
  id="productosModal"
  tabindex="-1"
  aria-labelledby="productosModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="productosModalLabel">Productos de la Venta</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Código de Venta:</strong> {{ ventaSeleccionada?.codigo }}</p>
        <ul class="list-group">
          <li
            *ngFor="let producto of ventaSeleccionada?.productos"
            class="list-group-item d-flex align-items-center"
          >
            <img
              [src]="'http://127.0.0.1:8000'+producto.producto.imagen"
              alt="{{ producto.producto.nombre }}"
              class="img-thumbnail me-3"
              style="width: 50px; height: 50px;"
            />
            <div>
              <p class="mb-0"><strong>{{ producto.producto.nombre }}</strong></p>
              <p class="mb-0">Cantidad: {{ producto.cantidad }}</p>
              <p class="mb-0">Precio Unitario: {{ producto.producto.precio | monedaChilena }}</p>
              <p class="mb-0">Total: {{ producto.cantidad * producto.producto.precio | monedaChilena }}</p>
            </div>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
